
#define BLYNK_TEMPLATE_ID "TMPL6JymvQgS0"
#define BLYNK_TEMPLATE_NAME "Monitoring ESP32"
#define BLYNK_AUTH_TOKEN "gbzEi61A3nh4gQyRjYgARmOw8L8LSFI3"

#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>
#include <ESP32Servo.h>

// ====== WiFi ======
char ssid[] = "iotsampah";
char pass[] = "12345678";

// ====== Ultrasonic Pins ======
const int trigPin = 25;
const int echoPin = 26;

// ====== Servo Pin ======
const int servoPin = 14;

long duration;
int distance;

Servo myServo;

// Threshold
int openThreshold  = 15;  // < 15cm → buka
int closeThreshold = 22;  // > 22cm → tutup

bool isOpen = false;

// ====== Baca jarak 3 kali, ambil rata-rata ======
int getStableDistance() {
  long sum = 0;
  for (int i = 0; i < 3; i++) {

    digitalWrite(trigPin, LOW);
    delayMicroseconds(2);

    digitalWrite(trigPin, HIGH);
    delayMicroseconds(10);
    digitalWrite(trigPin, LOW);

    duration = pulseIn(echoPin, HIGH, 20000);
    int d = duration * 0.034 / 2;
    sum += d;

    delay(10);
  }

  int avg = sum / 3;
  if (avg <= 0 || avg > 200) return 999;
  return avg;
}

// ====== Servo smooth ======
void moveServoSmooth(int startAngle, int endAngle) {
  if (startAngle < endAngle) {
    for (int pos = startAngle; pos <= endAngle; pos++) {
      myServo.write(pos);
      delay(5);
    }
  } else {
    for (int pos = startAngle; pos >= endAngle; pos--) {
      myServo.write(pos);
      delay(5);
    }
  }
}

void setup() {
  Serial.begin(115200);

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);

  // ====== Servo setup ======
  ESP32PWM::allocateTimer(0);
  ESP32PWM::allocateTimer(1);
  ESP32PWM::allocateTimer(2);
  ESP32PWM::allocateTimer(3);

  myServo.setPeriodHertz(50);
  myServo.attach(servoPin, 500, 2400);
  myServo.write(0);

  // ====== Blynk connect ======
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
}

void loop() {
  Blynk.run();

  distance = getStableDistance();

  Serial.print("Jarak: ");
  Serial.print(distance);
  Serial.println(" cm");

  // Kirim jarak ke Blynk → V0
  Blynk.virtualWrite(V0, distance);

  // ====== BUKA ======
  if (!isOpen && distance < openThreshold) {
    Serial.println("Tangan terdeteksi → membuka...");
    moveServoSmooth(0, 90);
    isOpen = true;

    // Kirim status ke Blynk → V1
    Blynk.virtualWrite(V1, "OPEN");

    delay(2000);
  }

  // ====== TUTUP ======
  if (isOpen && distance > closeThreshold) {
    Serial.println("Menutup tutup...");
    moveServoSmooth(90, 0);
    isOpen = false;

    // Kirim status ke Blynk → V1
    Blynk.virtualWrite(V1, "CLOSE");

    delay(500);
  }

  delay(100);
}
